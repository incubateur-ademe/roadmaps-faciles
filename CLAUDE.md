# CLAUDE.md — Roadmaps Faciles

## First things first
- Read this entire document before starting to code
- Read CLAUDE.local.md for local development setup instructions (if you find it)

## Tooling & environment
- `pnpm` is the package manager; lock file is `pnpm-lock.yaml`
- Node 24 required (`engines` in package.json)
- Next.js 16 App Router, standalone output, React Compiler enabled
- Prisma 7 — client is auto-generated into `src/generated/prisma/`; never edit manually
- `next-env.d.ts` is auto-generated by Next.js; ignore changes to it

## Scripts
- `pnpm dev` — start dev server
- `pnpm build` — production build
- `pnpm lint` — runs `next typegen && eslint`
- `pnpm prisma db seed` — seed dev database
- `pnpm prisma:studio` — open Prisma Studio (embedded in admin UI)
- `pnpm prisma:reset` — reset database and re-seed
- `pnpm export` — export standalone build

## Local services (docker-compose)
- PostgreSQL 15 → `localhost:5432` (db: roadmaps-faciles, user/pass: postgres/postgres)
- Redis → `localhost:6379`
- Maildev SMTP → `localhost:1025` (web UI: localhost:1080)
- Environment variables: see `.env.development` for all required vars with documentation

## Code conventions
- ESLint 9 flat config (`eslint.config.ts`) — strict rules enforced:
  - No default exports except Next.js special files (page, layout, error, loading, template, route, metadata)
  - Imports must be sorted (perfectionist plugin) — group external/internal with blank line between
  - Array types: use `Array<{...}>` for complex types, not `T[]`
  - Union/intersection types are auto-sorted alphabetically (`null | string`, not `string | null`)
- Path aliases (tsconfig): `@/*` → `src/*`, `@/utils/*` → `src/lib/utils/*`, `@/prisma/*` → `src/generated/prisma/*`
- UI: DSFR (French gov design system) is primary; components/utilities in `src/dsfr/`
  - Always prefer `react-dsfr` components (`Badge`, `Button`, `Select`, `ButtonsGroup`, `Tooltip`, `Pagination`, etc.) over raw DSFR CSS classes
  - Custom DSFR components in `src/dsfr/` (e.g., `Icon`, `TableCustom`) — check here before creating new wrappers
  - `TableCustom`: always use for admin tables — never native HTML tables or react-dsfr `Table`
  - `@/dsfr` barrel (`src/dsfr/server.ts`) exports: `Box`, `FormFieldset`, `Icon`, `Grid`, `GridCol`, `Container`, `CenteredContainer`
  - Grid layout: always use `Grid` + `GridCol` from `@/dsfr` — never raw `fr-grid-row`/`fr-col-*` divs
  - Fieldsets: always use `FormFieldset` from `@/dsfr` — never raw `<fieldset>`
  - SearchBar + Autocomplete: combine DSFR `SearchBar` (`renderInput`) + MUI `Autocomplete` (`renderInput` nested) for autocomplete inputs
  - MUI `Autocomplete` inside DSFR `SearchBar`: must add `className="flex-1"` on `Autocomplete` to fill the `fr-search-bar` flex container
  - "use client" function props: rename non-action callbacks to end with `Action` (e.g., `onSelectAction`) to avoid Next.js TS 71007 warning
  - DSFR badge colors: use `POST_STATUS_COLOR_MAP` to convert camelCase → kebab-case; avoid `fr.cx()` with dynamic template literals
  - react-dsfr `Pagination`: `defaultPage` is actually controlled (no internal state) — no `key` hack needed to sync
  - react-dsfr `ButtonsGroup`: `buttons` prop is typed as `[ButtonProps, ...ButtonProps[]]` tuple — conditional spreads break TypeScript; use separate renders for different button sets
  - react-dsfr `createModal`: use `createModal({ id, isOpenedByDefault: false })` at module level for DSFR-compliant modals; call `.open()` imperatively, render `<modal.Component>`
- Styles: Tailwind CSS 4 + SCSS (`globals.scss`)
  - Class composition: use `cx(fr.cx("dsfr-class"), "tw-class")` from `@codegouvfr/react-dsfr/tools/cx` — never template literals for mixing DSFR + Tailwind
- Styling preference: Tailwind for simple, SCSS modules for complex — never inline styles (`style={{...}}`)
- TypeScript: `ServerActionResponse<T>` requires explicit `!result.ok` check in else blocks for type narrowing

## Architecture
- Multi-tenant: domain-based routing via `src/app/[domain]/`
  - Tenant utils: `src/lib/utils/tenant.ts` — `getDomainFromHost()`, `getTenantFromDomain()`, `getTenantSubdomain()`
  - Server actions resolve domain internally via `getDomainFromHost()` (reads `x-forwarded-host`/`host` headers) — no `domain` param needed
  - `DomainParams`/`DomainProps` types exported from `src/app/[domain]/(domain)/layout.tsx`
  - `DomainPageHOP` in `src/app/[domain]/(domain)/DomainPage.tsx` wraps pages with tenant/settings
  - `EmptyObject` type: import from `@/utils/types` (not `react-hook-form`)
  - Auth: `assertTenantAdmin(domain)` takes domain explicitly — type `TenantAccessCheck = { domain: string } & AccessCheck` in `src/lib/utils/auth.ts`
  - Auth: `assertTenantModerator(domain)` — same pattern, min role MODERATOR. Used by `/moderation` section (separate from `/admin`)
  - Seed context: `setSeedTenant()`/`getSeedTenant()` in `src/lib/seedContext.ts` — for seed scripts only
- Auth: NextAuth v5 beta (`src/lib/next-auth/`), Espace Membre provider
  - SSO Bridge: `src/lib/authBridge.ts` — HMAC token transfer from root session to tenant via Credentials provider `"bridge"`
  - OAuth SSO: GitHub, Google, ProConnect — tenant-only, configured via `OAUTH_*` env vars in `src/config.ts`, activated per tenant in admin UI
  - 2FA: passkey (WebAuthn), OTP (TOTP), email — APIs in `src/app/(default)/api/{webauthn,otp,2fa}/`
  - 2FA verification: Redis proof (`2fa:proof:{userId}`, TTL 60s) — endpoint stores proof on success, JWT callback consumes it on `session.update()`
  - Force 2FA: admin toggle (root + tenant level) with grace period (0–5 days), deadline stored in `User.twoFactorDeadline`
  - `DefaultAuthenticatedLayout`: reads `x-pathname` header (set in `src/proxy.ts`) for redirect loop prevention (2FA setup vs verify)
- Data layer: Prisma repos in `src/lib/repo/`, services in `src/lib/services/`, use cases in `src/useCases/`
- Audit log: fire-and-forget `audit()` in `src/lib/utils/audit.ts`
  - Pattern in server actions: call `getRequestContext()` BEFORE try/catch and early returns, then `audit()` on success, catch, AND validation early returns. `RequestContext` includes `correlationId` (from proxy header).
  - `AuditInput.metadata` accepts `Record<string, unknown>` — cast to `Prisma.InputJsonValue` happens internally in `audit()`
  - TS interfaces lack implicit index signatures — use `{ ...obj }` spread to convert interface to `Record<string, unknown>`
  - `AuditLog` Prisma model has no FK intentionally — logs survive user/tenant deletion; batch user lookup via Map in repo
- Observability: Pino (structured logging) + Sentry (optional error tracking/tracing)
  - Logger: `src/lib/logger.ts` — `server-only` singleton; `pino-pretty` in dev, JSON in prod
  - Sentry: enabled by `SENTRY_DSN` env var; when empty, fully disabled (zero overhead)
  - Sentry source maps: only uploaded in prod/staging (`APP_ENV` check in `next.config.ts`)
  - Correlation ID: generated in `src/proxy.ts`, propagated via `x-correlation-id` header (request + response)
  - Request logger: `createRequestLogger(reqCtx)` in `src/lib/utils/requestLogger.ts` — child logger with correlationId
  - Health check: `/api/healthz` route handler (JSON, checks DB + Redis, 200/503)
  - Server-side `console.*` → use `logger` from `@/lib/logger`; client-side `console.error` stays (Sentry captures automatically)
- Domain providers: `src/lib/domain-provider/` — `IDomainProvider` abstraction + factory `getDomainProvider()` (noop, scalingo, scalingo-wildcard, clevercloud, caddy)
- DNS providers: `src/lib/dns-provider/` — `IDnsProvider` abstraction + factory `getDnsProvider()` (noop, manual, ovh, cloudflare)
  - DNS errors are non-blocking in use cases (try/catch + `logger.warn`)
  - `CreateNewTenantOutput` is `{ tenant: TenantWithSettings, dns?: DnsProvisionResult }` — access `result.tenant.id`, not `result.id`
- Post approval: `TenantSettings.requirePostApproval` → posts created as PENDING (filtered from board) until moderator approves
  - Anonymous posts: `Post.userId` nullable + `anonymousId` field; always null-check `post.user` in renders
- Board views: `view=list|cards` URL param toggles compact list vs card layout; `VIEW_ENUM`/`ORDER_ENUM` pattern for `z.enum()` search param validation in `types.ts`
- Caching: Redis via ioredis + unstorage
- Email: react-email templates (`src/emails/`) + Nodemailer (`src/lib/mailer.ts` — shared `sendEmail()`, maildev in dev)
  - Layout DSFR Mail: `DsfrEmailLayout` (header/footer Marianne, dark mode, responsive 600px)
  - Composants helpers: `DsfrButton`, `DsfrText`, `DsfrHeading`, `DsfrSpacer` in `src/emails/components.tsx`
  - Render facade: `src/emails/renderEmails.tsx` — fonctions `renderXxxEmail()` (keeps JSX out of `.ts` files)
  - i18n: `getEmailTranslations()` in `src/emails/getEmailTranslations.ts` — standalone (loads JSON directly, no next-intl server context dependency)
- i18n: next-intl v4 — cookie-based locale (no URL prefix), fr (default) + en
  - Config: `src/i18n/request.ts` (reads `NEXT_LOCALE` cookie), utils/types in `src/lib/utils/i18n.ts`
  - Messages: `messages/fr.json` + `messages/en.json` — 23 namespaces, ICU plural syntax supported
  - Navigation: `src/i18n/navigation.tsx` — simple re-exports from `next/link` / `next/navigation` (no locale prefix)
  - Server components/actions: `await getTranslations("namespace")` + `await getLocale()` from `next-intl/server`
  - Client components: `useTranslations("namespace")` + `useLocale()` from `next-intl`
  - Zod validation schemas: accept `ValidationTranslator` param for translated error messages (`src/lib/utils/zod-schema.ts`)
  - Date formatting: `formatDateHour(date, locale)` / `formatRelativeDate(date, locale)` in `src/lib/utils/date.ts`
  - Language switch: DSFR `LanguageSelect` + cookie set + `window.location.reload()` in `src/app/LanguageSelectClient.tsx`

## Workflow
- Always run `pnpm lint --fix` first, then `pnpm build` to catch type errors, BEFORE committing
- Fix all lint errors and TypeScript errors before committing — do not leave unused variables, dead imports, or type errors
- When asked to implement a feature, produce working code — not just a plan. Only produce a plan if explicitly asked for planning/architecture discussion
- If a task is too large for one session, implement as much as possible and clearly list remaining items

## Worktrees (multi-Claude en parallèle)
- Chaque session Claude parallèle travaille dans son propre git worktree — JAMAIS deux sessions sur le même répertoire
- Le worktree DOIT être créé AVANT de lancer Claude et Claude DOIT être lancé depuis le worktree (`cd <worktree-dir> && claude`)
- Après compaction, le hook global `SessionStart(compact)` (plugin `worktree-monitor`) injecte la liste des worktrees — Claude DOIT alors utiliser `AskUserQuestion` pour confirmer le worktree actif avec l'utilisateur
- Le skill `/worktree-monitor:set` peut être invoqué manuellement pour re-confirmer/changer le worktree actif
- Le skill `/worktree-monitor:setup` configure les hooks et la status line dans les settings globaux
- Chaque worktree a son propre `.env.development.local`, ses propres `node_modules`, et son propre `src/generated/prisma/`
- Par défaut le worktree partage la DB et le port du repo principal (cas courant sans conflit)
- Création : `scripts/worktree-new.sh <branch> [--port <port>] [--db] [--from <branch>]`
  - `--db` : crée une DB dédiée + `prisma db push` + seed (pour migrations/schéma divergent)
  - `--port <port>` : port custom (pour lancer plusieurs dev servers en parallèle)
  - `--from <branch>` : branche de base (défaut: `dev`)
- Nettoyage après merge : `scripts/worktree-clean.sh <branch> [--drop-db]`
- Autocompletion zsh : `source scripts/worktree-completion.zsh` (dans `~/.zshrc`)
- Convention de nommage : `<repo>-<short-branch-name>` (ex: `kokatsuna-auth-2fa` pour `feat/auth-2fa`)

## Git conventions
- Use `git add .` before committing (no need to selectively stage files)
- Do not add `Co-Authored-By` trailers to commits
- Follow conventional commit format: `feat`/`fix`/`chore`/`docs`(`scope`): description
- Do not add "Generated with Claude Code" footer in PR descriptions

## GitHub
- NEVER mention `@copilot-pull-request-reviewer` or any bot handle in PR comments or review replies — this triggers automated bot actions (unwanted PRs, review loops)

## Testing
- No test framework configured — no unit/integration/e2e tests in the project currently

## Security
- Use cases must validate both source and target values (e.g., `UpdateMemberRole` blocks setting role to OWNER/INHERITED, not just checking current role)
- Use cases operating on tenant-scoped resources must validate `tenantId` matches the caller's tenant (auth checks role, not resource ownership)
- Role checks: use `USER_ROLE` enum for comparisons — never magic strings or boolean helpers like `isSuperAdmin` unless the logic truly requires super-admin only
- Tenant-level roles come from tenant membership, NOT from the global user role — always check the correct scope

## Gotchas
- `config.rootDomain` includes the port (only strips protocol + `www.`) — domain/DNS providers must strip port with `.replace(/:\d+$/, "")` themselves
- DNS CNAME trailing dot: resolvers may return `"target.io."` — always normalize with `.replace(/\.$/, "")` before comparing
- `src/generated/` is gitignored (except `.gitattributes`) — run `pnpm prisma generate` if client is missing
- Zod 4 is used (not v3) — API differs slightly; docs available via MCP: `https://mcp.inkeep.com/zod/mcp`
- Next.js 16 `cacheComponents: true` is incompatible with route config exports (`dynamic`, `revalidate`, etc.) — use `await connection()` from `next/server` in pages instead
- Circular Zod schemas: use `z.lazy(() => Schema)` to avoid initialization errors
- Multi-tenant pages under `[domain]`: wrap children in `<Suspense>` + use `await connection()` to force dynamic rendering
- DSFR `fr-container--fluid` has `overflow: hidden` — override with `!overflow-visible` (Tailwind `!important`) when content needs to scroll/overflow
- DSFR `.fr-select-group:not(:last-child)` adds `margin-bottom: 1.5rem` — counter with `[&_.fr-select-group]:!mb-0` when using inline Select groups
- NextAuth `signIn()` uses `cookies().set()` internally — cannot be called during RSC render (read-only). Use a Server Action (form auto-submit pattern) instead
- Route Handlers: use `NextResponse.redirect()`, not `redirect()` from `next/navigation` (which throws and is for RSC/Server Actions only)
- Multi-tenant Route Handlers: never use `request.url` as base for root URLs — use `config.host` directly (request may reflect tenant domain)
- `DomainPageHOP` generic param is for route Params only, not page props — access `searchParams` via cast: `(props as unknown as { searchParams: Promise<...> }).searchParams`
- Workflow: always run `pnpm lint --fix` before manually fixing ESLint diagnostics (import sorting, formatting, etc.)
- `pino` and `pino-pretty` must be in `serverExternalPackages` in `next.config.ts` — Turbopack cannot bundle them
- `@sentry/nextjs` v10: use `webpack.autoInstrumentServerFunctions`, `webpack.treeshake.removeDebugLogging` (top-level equivalents are deprecated)
- Next.js 16 uses `src/proxy.ts` (not `middleware.ts`) — correlation ID, rewrites, and request header injection all happen there
- DSFR `Alert` with `small` prop requires `description` (even `description=""`) — TypeScript discriminated union requires it
- Prisma enum values: always use model constants (`POST_APPROVAL_STATUS.APPROVED`) instead of string literals (`"APPROVED"`) in queries and use cases
- Board pagination: `handleLoadMore` must compute `nextPage = page + 1` BEFORE fetching — fetching with current `page` then incrementing causes duplicate data on first load
- Email templates (`src/emails/`): inline `style={{...}}` is required — email clients don't support external CSS/Tailwind; this is the exception to the "no inline styles" rule
- Out-of-scope bugs: when spotting bugs or issues outside the current feature scope, propose corrections rather than ignoring them
- `@auth/core` provider merge: `Nodemailer()` stores user config in `options` field; `parseProviders()` does `merge(defaults, userOptions)` which overrides top-level keys with `options.*` — the espace-membre-provider wrapper must flatten `options` into the base config (fixed in v0.3.3)
- OAuth env vars use `OAUTH_` prefix (`OAUTH_GITHUB_CLIENT_ID`, etc.) — only `src/config.ts` reads `process.env.*`, rest uses `config.oauth.*`
