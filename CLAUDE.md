# CLAUDE.md — Kokatsuna / Roadmaps Faciles

## Tooling & environment
- `pnpm` is the package manager; lock file is `pnpm-lock.yaml`
- Node 24 required (`engines` in package.json)
- Next.js 16 App Router, standalone output, React Compiler enabled
- Prisma 7 — client is auto-generated into `src/generated/prisma/`; never edit manually
- `next-env.d.ts` is auto-generated by Next.js; ignore changes to it

## Scripts
- `pnpm dev` — start dev server
- `pnpm build` — production build
- `pnpm lint` — runs `next typegen && eslint`
- `pnpm prisma db seed` — seed dev database
- `pnpm prisma:studio` — open Prisma Studio (embedded in admin UI)

## Local services (docker-compose)
- PostgreSQL 15 → `localhost:5432` (db: roadmaps-faciles, user/pass: postgres/postgres)
- Redis → `localhost:6379`
- Maildev SMTP → `localhost:1025` (web UI: localhost:1080)

## Code conventions
- ESLint 9 flat config (`eslint.config.ts`) — strict rules enforced:
  - No default exports except Next.js special files (page, layout, error, loading, template, route, metadata)
  - Imports must be sorted (perfectionist plugin) — group external/internal with blank line between
  - Array types: use `Array<{...}>` for complex types, not `T[]`
- Path aliases (tsconfig): `@/*` → `src/*`, `@/utils/*` → `src/lib/utils/*`, `@/prisma/*` → `src/generated/prisma/*`
- UI: DSFR (French gov design system) is primary; components/utilities in `src/dsfr/`
  - Always prefer `react-dsfr` components (`Badge`, `Button`, `Select`, `ButtonsGroup`, `Tooltip`, `Pagination`, etc.) over raw DSFR CSS classes
  - Custom DSFR components in `src/dsfr/` (e.g., `Icon`, `TableCustom`) — check here before creating new wrappers
  - DSFR badge colors: use `POST_STATUS_COLOR_MAP` to convert camelCase → kebab-case; avoid `fr.cx()` with dynamic template literals
  - react-dsfr `Pagination`: `defaultPage` is actually controlled (no internal state) — no `key` hack needed to sync
- Styles: Tailwind CSS 4 + SCSS (`globals.scss`)
- TypeScript: `ServerActionResponse<T>` requires explicit `!result.ok` check in else blocks for type narrowing

## Architecture
- Multi-tenant: domain-based routing via `src/app/[domain]/`
  - Tenant utils: `src/lib/utils/tenant.ts` — `getDomainFromHost()`, `getTenantFromDomain()`, `getTenantSubdomain()`
  - Server actions resolve domain internally via `getDomainFromHost()` (reads `x-forwarded-host`/`host` headers) — no `domain` param needed
  - `DomainParams`/`DomainProps` types exported from `src/app/[domain]/(domain)/layout.tsx`
  - `DomainPageHOP` in `src/app/[domain]/(domain)/DomainPage.tsx` wraps pages with tenant/settings
- Auth: NextAuth v5 beta (`src/lib/next-auth/`), Espace Membre provider
- Data layer: Prisma repos in `src/lib/repo/`, services in `src/lib/services/`, use cases in `src/useCases/`
- Caching: Redis via ioredis + unstorage
- Email: Nodemailer (maildev in dev)

## Security
- Use cases must validate both source and target values (e.g., `UpdateMemberRole` blocks setting role to OWNER/INHERITED, not just checking current role)

## Gotchas
- `src/generated/` is gitignored (except `.gitattributes`) — run `pnpm prisma generate` if client is missing
- Zod 4 is used (not v3) — API differs slightly
- Next.js 16 `cacheComponents: true` is incompatible with route config exports (`dynamic`, `revalidate`, etc.) — use `await connection()` from `next/server` in pages instead
- Circular Zod schemas: use `z.lazy(() => Schema)` to avoid initialization errors
- Multi-tenant pages under `[domain]`: wrap children in `<Suspense>` + use `await connection()` to force dynamic rendering
