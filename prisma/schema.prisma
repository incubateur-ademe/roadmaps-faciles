// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["typedSql", "views", "fullTextSearchPostgres"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model ApiKey {
  id                Int      @id @default(autoincrement())
  tenantId          Int
  userId            String
  commonTokenPrefix String
  randomTokenPrefix String
  tokenDigest       String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([userId, tenantId])
  @@unique([tokenDigest])
  @@index([tenantId])
  @@index([userId])
}

model Board {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  order       Int
  slug        String?
  tenantId    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant               Tenant            @relation(fields: [tenantId], references: [id])
  posts                Post[]
  pin                  Pin?
  tenantSettingForRoot TenantSettings?
  postsWithHotness     PostWithHotness[]

  @@unique([name, tenantId])
  @@unique([slug, tenantId])
  @@index([tenantId])
}

model Comment {
  id           Int      @id @default(autoincrement())
  body         String?
  userId       String
  postId       Int
  parentId     Int?
  isPostUpdate Boolean  @default(false)
  tenantId     Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id])
  post       Post       @relation(fields: [postId], references: [id])
  parent     Comment?   @relation("CommentParent", fields: [parentId], references: [id])
  replies    Comment[]  @relation("CommentParent")
  activities Activity[]

  @@index([parentId])
  @@index([postId])
  @@index([tenantId])
  @@index([userId])
}

model Follow {
  id        Int      @id @default(autoincrement())
  userId    String
  postId    Int
  tenantId  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  post Post @relation(fields: [postId], references: [id])

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@index([tenantId])
}

model Invitation {
  id          Int       @id @default(autoincrement())
  email       String
  tokenDigest String
  acceptedAt  DateTime?
  tenantId    Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([email, tenantId])
  @@index([tenantId])
}

model Like {
  id          Int      @id @default(autoincrement())
  userId      String?
  anonymousId String?
  postId      Int
  tenantId    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id])
  post Post  @relation(fields: [postId], references: [id])

  @@unique([userId, postId])
  @@unique([anonymousId, postId])
  @@index([userId])
  @@index([postId])
  @@index([tenantId])
}

enum PostStatusColor {
  grey
  gray
  blueFrance
  redMarianne
  greenTilleulVerveine
  greenBourgeon
  greenEmeraude
  greenMenthe
  greenArchipel
  blueEcume
  blueCumulus
  purpleGlycine
  pinkMacaron
  pinkTuile
  yellowTournesol
  yellowMoutarde
  orangeTerreBattue
  brownCafeCreme
  brownCaramel
  brownOpera
  beigeGrisGalet
  info
  success
  warning
  error
}

model PostStatus {
  id            Int             @id @default(autoincrement())
  name          String
  color         PostStatusColor
  order         Int
  showInRoadmap Boolean         @default(false)
  tenantId      Int
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  tenant       Tenant             @relation(fields: [tenantId], references: [id])
  posts        Post[]
  statusChange PostStatusChange[]

  @@unique([name, tenantId])
  @@index([tenantId])
}

enum PostApprovalStatus {
  APPROVED
  PENDING
  REJECTED
}

model Post {
  id             Int                @id @default(autoincrement())
  title          String
  description    String?
  boardId        Int
  postStatusId   Int?
  tenantId       Int
  userId         String
  slug           String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  approvalStatus PostApprovalStatus @default(APPROVED)
  tags           String[]

  board      Board            @relation(fields: [boardId], references: [id])
  user       User             @relation(fields: [userId], references: [id])
  postStatus PostStatus?      @relation(fields: [postStatusId], references: [id])
  comments   Comment[]
  follows    Follow[]
  likes      Like[]
  pin        Pin?
  hotness    PostWithHotness?
  activities Activity[]

  textsearchable_index_col Unsupported("tsvector GENERATED ALWAYS AS (to_tsvector('french'::regconfig, COALESCE(title, ''::text) || ' ' || COALESCE(description, ''::text))) STORED;")?

  // @@fulltext([title, description])
  // @@fulltext([description])
  // @@fulltext([title])

  @@unique([slug, tenantId])
  @@index([textsearchable_index_col], type: Gin)
  @@index([boardId])
  @@index([postStatusId])
  @@index([tenantId])
  @@index([userId])
  @@index([tags])
}

enum ActivityType {
  COMMENT
  FOLLOW
  STATUS_CHANGE
  LIKE
}

view Activity {
  id             Int          @unique
  postId         Int
  type           ActivityType
  count          Int
  startTime      DateTime
  endTime        DateTime
  commentId      Int?
  statusChangeId Int?

  post         Post              @relation(fields: [postId], references: [id])
  comment      Comment?          @relation(fields: [commentId], references: [id])
  statusChange PostStatusChange? @relation(fields: [statusChangeId], references: [id])
}

view PostWithHotness {
  id      Int     @unique
  hotness Decimal @default(0.0)
  boardId Int
  postId  Int     @unique
  post    Post    @relation(fields: [postId], references: [id])
  board   Board   @relation(fields: [boardId], references: [id])
}

model Pin {
  id      Int @id @default(autoincrement())
  boardId Int @unique
  postId  Int @unique

  board Board @relation(fields: [boardId], references: [id])
  post  Post  @relation(fields: [postId], references: [id])
}

model PostStatusChange {
  id           Int      @id @default(autoincrement())
  userId       String
  postId       Int
  postStatusId Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenantId     Int

  postStatus PostStatus? @relation(fields: [postStatusId], references: [id])
  activities Activity[]

  @@index([postId])
  @@index([postStatusId])
  @@index([tenantId])
  @@index([userId])
}

enum Locale {
  fr
  en
}

model Tenant {
  id         Int             @id @default(autoincrement())
  deletedAt  DateTime?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  apiKeys    ApiKey[]
  boards     Board[]
  settings   TenantSettings?
  members    UserOnTenant[]
  postStatus PostStatus[]
}

enum EmailRegistrationPolicy {
  ANYONE
  NOONE
  DOMAINS
}

model TenantSettings {
  id                      Int                     @id @default(autoincrement())
  tenantId                Int                     @unique
  name                    String
  customDomain            String?
  subdomain               String
  locale                  Locale                  @default(fr)
  useBrowserLocale        Boolean                 @default(false)
  isPrivate               Boolean                 @default(false)
  allowVoting             Boolean                 @default(true)
  allowComments           Boolean                 @default(true)
  allowAnonymousVoting    Boolean                 @default(true)
  allowPostEdits          Boolean                 @default(false)
  showRoadmapInHeader     Boolean                 @default(false)
  collapsedBoards         Boolean                 @default(false)
  allowAnonymousFeedback  Boolean                 @default(true)
  showVoteCount           Boolean                 @default(true)
  showVoteButton          Boolean                 @default(true)
  emailRegistrationPolicy EmailRegistrationPolicy @default(ANYONE)
  allowedEmailDomains     String[]
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  rootBoardId             Int?                    @unique

  rootBoard Board? @relation(fields: [rootBoardId], references: [id])
  tenant    Tenant @relation(fields: [tenantId], references: [id])

  @@unique([customDomain])
  @@unique([subdomain])
  @@index([tenantId])
  @@index([rootBoardId])
}

model TenantDefaultOAuth {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  provider  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, provider])
  @@index([tenantId])
}

enum UserStatus {
  ACTIVE
  BLOCKED
  DELETED
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
  OWNER
  INHERITED
}

model User {
  id                         String     @id @default(cuid())
  name                       String?
  email                      String     @unique
  emailVerified              DateTime?
  username                   String?    @unique
  image                      String?
  notificationsEnabled       Boolean    @default(true)
  status                     UserStatus @default(ACTIVE)
  role                       UserRole   @default(USER)
  signInCount                Int        @default(0)
  currentSignInAt            DateTime?
  lastSignInAt               DateTime?
  currentSignInIp            String?
  lastSignInIp               String?
  recapNotificationFrequency Int        @default(0)
  createdAt                  DateTime   @default(now())
  updatedAt                  DateTime   @updatedAt
  isBetaGouvMember           Boolean    @default(false)

  posts          Post[]
  apiKeys        ApiKey[]
  comments       Comment[]
  follows        Follow[]
  likes          Like[]
  memberships    UserOnTenant[]
  accounts       Account[]
  sessions       Session[]
  // Optional for WebAuthn support
  authenticators Authenticator[]
}

model UserOnTenant {
  userId   String
  tenantId Int

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  role     UserRole   @default(USER)
  status   UserStatus @default(ACTIVE)
  joinedAt DateTime   @default(now())

  @@id([userId, tenantId])
  @@index([tenantId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// Optional for WebAuthn support
model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}

model OAuth {
  id        Int      @id @default(autoincrement())
  provider  String
  uid       String
  userId    String
  tenantId  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, uid, tenantId])
  @@index([userId])
  @@index([tenantId])
}

model Webhook {
  id        Int      @id @default(autoincrement())
  tenantId  Int
  url       String
  event     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}
